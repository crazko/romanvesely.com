---
layout: post
title: 'Statie: generate & refresh'
description: '''
Make development with <a href="https://github.com/Symplify/Statie">Statie</a> a bit more convenient with little use of <a href="http://gulpjs.com/">gulp</a> and <a href="https://browsersync.io/">Browsersync</a>. We will also take a look at how to implement <a href="http://lesscss.org/">Less</a> preprocessor in the workflow.
'''
---

With a rising popularity of static site generators we can find that there are [many of them][1] already in use. This blog runs on [Statie][2], another such a tool written by [Tomas Votruba](https://www.tomasvotruba.cz/), which differs from the others with [Nette](https://nette.org/) and its templating engine [Latte](https://latte.nette.org/) used in the background.

If you are not aware what is this tool all about let's take firstly a look at a post series about it on [Tomas' blog][3]. It will lead you from the very beginning on how to run your own site upon Statie, so I won't deal with this here.

In the end of the mentioned blog post we can find a [simple gulp task](https://www.tomasvotruba.cz/blog/2017/02/20/statie-how-to-run-it-locally/#minitip-use-gulp-work-for-you) that runs generate command on every change in the source files. This is surely handy, but you still need to refresh your browser to be able to see your changes. With **Browsersync** we can make this step unecessary.

## Running an executable command
With `vendor/bin/statie generate` command we can generate our site content. In `gulpfile.js` we may have something like this:

``` javascript
var gulp = require('gulp');
var exec = require('child_process').exec

gulp.task('default', function () {
	exec('vendor/bin/statie generate');
});
```

The problem is it doesn't give you a message when the job is done, so you cannot tell when to refresh a browser to see new content. To get over this problem [gulp-run](https://github.com/MrBoolean/gulp-run) package may be used.

In short - previously I did [some haraiki](https://github.com/crazko/romanvesely.com/blob/1b9a194de34461da23545ce966c3242477466976/gulpfile.js) to make it work together with [gulp-sequence](https://www.npmjs.com/package/gulp-sequence) plugin. Fortunately, I recently found there is a new version of gulp comming with some handy features, namely: **gulp.series** and **gulp.parallel** which combine multiple functions together so tasks don't have to have dependecies anymore. And we can use those features now! Please, read a [guide how to set up gulp 4][4] before you proceed.

## Watching over changes

Get everything needed to start:

``` bash
$ npm install --save-dev gulpjs/gulp.git#4.0 gulp-watch gulp-run browser-sync
```

Add some foundation to the `gulpfile.js`:

``` javascript
var gulp = require('gulp');
var run = require('gulp-run');
var browserSync = require('browser-sync').create();

function generate() {
  return plugins.run('vendor/bin/statie generate').exec();
};

function reload(done) {
  browserSync.reload();
  done();
}
```

Such simple functions, aren't they? Simple, yet they do everything we need to have to set up a watcher function. Short notes on above code:

- in `generate()` function `return` has to be used in order to use it in a `gulp.series()` properly
- same applies for `done()` function used in `reload()` - repeated reloading would be not possible without it

Here comes the watcher function:

``` javascript
function watch() {
  browserSync.init({
    server: 'output'
  });

  gulp.watch('source/**/*', gulp.series(generate, reload));
}
```

With `gulp.series(generate, reload)` we say we want to reload the browser when new content generation finished, not before. Last step is to create a gulp task that will use previously defined functions:

``` javascript
gulp.task('default', gulp.parallel(generate, watch));
```

Now, when you run `gulp`, new content is generated by Statie along with local server running on [localhost:3000](http://localhost:3000) (default settings). Try to edit source files and save them. Browsersync should spot the changes that were generated into `output` folder and instantly refresh the browser.

So we removed one step in our development process. **Content edition is no pain anymore!**

## Integrate a preprocessor
I often use Less to not get headache with working with CSS. Let's also add it to our Statie-based project and integrate it into the generating workflow.

``` bash
$ npm install --save-dev gulp-less
```

``` javascript
var less = require('gulp-less');

function styles() {
  return gulp.src('source/less/main.less')
    .pipe(less())
    .pipe(gulp.dest('output/css/styles.css'))
    .pipe(browserSync.stream());
};
```

Now we need to add this function to the default gulp task, and also edit the `watch()` function - we don't want to generate new content when less files were changed, but instead create new styles. Here is the final version of `gulpfile.js`:

``` javascript
var gulp = require('gulp');
var run = require('gulp-run');
var less = require('gulp-less');
var browserSync = require('browser-sync').create();

gulp.task('default', gulp.parallel(styles, generate, watch));

function styles() {
  return gulp.src('source/less/main.less')
    .pipe(less())
    .pipe(gulp.dest('output/css/styles.css'))
    .pipe(browserSync.stream());
};

function generate() {
  return plugins.run('vendor/bin/statie generate').exec();
};

function reload(done) {
  browserSync.reload();
  done();
}

function watch() {
  browserSync.init({
    server: 'output'
  });

  gulp.watch('source/**/*.less', styles);
  gulp.watch(['source/**/*', '!source/less/**/*'], gulp.series(generate, reload));
}
```

## Conclusion
With gulp 4 new features **gulp.series** and **gulp.parallel** is really easy to create a building workflow when one function depends on another. You can deal with javascipt in a same way as with Less styles, just create new function for that and edit the watch function and gulp task

You can also add different task to build production ready code - as I did. Have a look at the [gulpfile.js of this site](https://github.com/crazko/romanvesely.com/blob/master/gulpfile.js).

Do you know about anything that can improve this approach or do you use something completely different? Let me know.

## Sources
- [StaticGen - Top Open-Source Static Site Generators][1]
- [Statie - PHP Static Site Generator][2]
- [Statie: How to run it Locally][3]
- [The Complete-Ish Guide to Upgrading to Gulp 4][4]
- [Browsersync - Browser Reloading](https://www.browsersync.io/docs/gulp#gulp-reload)

[1]: http://www.staticgen.com/
[2]: https://github.com/Symplify/Statie
[3]: https://www.tomasvotruba.cz/blog/2017/02/20/statie-how-to-run-it-locally/
[4]: https://www.joezimjs.com/javascript/complete-guide-upgrading-gulp-4/
